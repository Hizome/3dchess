# Vercel 部署资源加速执行计划（3D 将棋）

## 目标
- 降低首次进入 3D 场景的加载时间。
- 降低二次访问等待时间与带宽开销。
- 保持现有功能不回退（行棋、打入、升变、调试面板）。

## 当前瓶颈（现状）
- `public/vintage` 下 GLB 体积总量较大（多模型均为高体积）。
- 首屏一次性加载多个模型，阻塞进入体验。
- 未针对 GLB 做长期缓存与版本化策略。

## 执行顺序（按收益优先）

## 阶段 1：离线压缩 GLB（最高优先） ✅ 已完成
- 目标：把模型体积压到当前的 10%~30%（视模型结构而定）。
- 动作：
  1. 使用 `gltf-transform` 对所有 GLB 执行几何压缩（Draco 或 Meshopt）。
  2. 贴图转 `KTX2(BasisU)`，并降分辨率（按棋子/棋盘可见性分档）。
  3. 清理无用节点、重复材质、未使用动画/数据。
- 验收：
  1. `public/vintage` 总体积显著下降。
  2. 视觉质量在可接受范围（棋子轮廓、文字、木纹不明显劣化）。

### 阶段 1 执行记录（2026-02-25）
- 执行内容：
  1. 使用 `gltf-transform optimize --compress draco` 批量压缩 `public/vintage/*.glb`。
  2. 在 `public/draco` 放置 Draco 解码器文件（`draco_decoder.js/.wasm` 等）。
  3. 在 `src/utils/AssetManager.ts` 接入 `DRACOLoader`（`setDecoderPath('/draco/')`）。
- 结果：
  1. `public/vintage` 总体积从约 `157MB` 降至约 `36MB`。
  2. 单个 GLB 从约 `15MB` 降至约 `3.3MB`。

## 阶段 2：首屏最小加载 + 按需加载
- 目标：先可玩，再补全资源。
- 动作：
  1. 首屏只加载：棋盘、局台、必要棋子模型（最小可行集合）。
  2. 非关键模型延迟加载（首次需要该棋种时再拉取）。
  3. 保留 fallback mesh，防止模型未到时交互中断。
- 验收：
  1. 点击 Play 到可操作时间明显缩短。
  2. 无“黑屏等待全部资源”现象。

## 阶段 3：Vercel 静态资源缓存策略
- 目标：二次访问尽量不重复下载模型。
- 动作：
  1. 给 GLB/KTX2 配 `Cache-Control: public, max-age=31536000, immutable`。
  2. 采用文件名 hash 或版本目录（例如 `/vintage-v2/`），避免缓存脏读。
  3. JSON 配置可用短缓存或 `no-cache`（便于调参即时生效）。
- 验收：
  1. 二次打开时资源基本走缓存。
  2. 版本切换后能正确更新资源。

## 阶段 4：预加载关键资源
- 目标：利用用户在菜单停留时间提前拉取关键资产。
- 动作：
  1. 在风格选择页预拉取 `board/place` 等关键模型。
  2. 对高概率使用的棋种做低优先级预取。
- 验收：
  1. 进入场景后首屏等待进一步下降。

## 阶段 5：运行时与内存优化（持续项）
- 目标：降低卡顿和内存峰值。
- 动作：
  1. 继续复用材质/几何，避免重复 clone 的资源持有。
  2. 保持不再使用的对象及时 dispose。
  3. 根据设备能力动态限制像素比与阴影开销。
- 验收：
  1. 长时间对局内存增长可控。
  2. 中低端设备帧率更稳定。

## 指标与观测
- 首屏可交互时间（Play -> 可走子）。
- 首次下载总字节数。
- 二次访问网络请求数与总字节数。
- 场景稳定帧率（对局中镜头旋转/落子动画）。

## 风险与回滚
- 风险：压缩后模型法线/贴图异常、材质失真、坐标基准变化。
- 处理：
  1. 每阶段保留原始资源与版本目录。
  2. 发现视觉回退可按模型回滚（单文件回滚）。

## 执行节奏建议
1. 先做阶段 1（压缩）并验证视觉。
2. 再做阶段 3（缓存）确保线上收益。
3. 然后做阶段 2（按需加载）拉高首屏体验。
4. 最后做阶段 4/5 持续优化。
