# 中国象棋模式实施计划（基于当前国际象棋实现）

## 1. 目标与范围
- 在现有 3D 国际象棋项目中新增「中国象棋模式（Xiangqi）」。
- 复用现有工程骨架（Vue + Three.js + 场景交互 + 动画 + 设置/HUD）。
- 新增中国象棋规则、棋盘坐标系统、棋子资产与走子记录逻辑。
- 不破坏当前国际象棋模式，可在模式入口切换。

## 2. 总体策略（最小风险）
- 前端架构保持不变，按“模式适配层”扩展，而不是重写全项目。
- 渲染层复用 `ChessScene` 的三维场景、光照、相机、拾取、动画框架。
- 逻辑层新增 `XiangqiLogic`（与 `GameLogic` 平行），接口尽量对齐。
- 资产层新增一套中国象棋模型命名约定，复用当前 AssetManager。

## 3. 架构拆分建议
### 3.1 模式抽象
- 新增模式枚举：`'chess' | 'xiangqi'`。
- App 层负责模式选择与场景参数下发。
- Scene 层按模式切换：
  - 棋盘尺寸/坐标映射
  - 合法走法查询
  - 棋子模型映射

### 3.2 逻辑层
- 保留 `GameLogic.ts`（国际象棋）。
- 新增 `XiangqiLogic.ts`：
  - 初始化局面
  - 合法走法计算
  - `makeMove / undo / reset / history / turn`
- 统一接口（建议）：
  - `getBoard()`
  - `getTurn()`
  - `getLegalMoves(square)`
  - `makeMove(from, to)`
  - `undoMove()`
  - `resetGame()`
  - `getHistory()`
- 规则引擎优先采用 `xiangqi.js`（npm）作为底层规则库，减少手写规则错误风险。
  - 建议封装方式：`XiangqiLogic` 作为对 `xiangqi.js` 的适配层，对外保持与当前 `GameLogic` 接口一致。

### 3.3 渲染与交互
- Scene 复用现有点击/高亮/动画流程。
- 新增象棋坐标映射（9x10 网格 + 楚河汉界）。
- 高亮逻辑复用，但目标点和坐标换算按象棋规则。

### 3.4 资产层
- 新增目录建议：
  - `src/assets/xiangqi/board.glb`
  - `src/assets/xiangqi/pieces/*.glb`
- 命名建议（红黑 + 子种）：
  - 红：`r_ju`, `r_ma`, `r_xiang`, `r_shi`, `r_jiang`, `r_pao`, `r_bing`
  - 黑：`b_ju`, `b_ma`, `b_xiang`, `b_shi`, `b_jiang`, `b_pao`, `b_bing`
- 保留当前“偏移/缩放调试面板 -> 固定参数”工作流。

## 4. 开发阶段
## Phase 0：模式入口与骨架（1-2 天）
- 菜单新增模式选择。
- App 透传 `mode` 到场景。
- Scene 内先放占位象棋棋盘 + 圆柱棋子，跑通回合与点击。

## Phase 1：规则引擎（2-4 天）
- 接入并封装 `xiangqi.js`，实现 `XiangqiLogic`（可先不做额外扩展规则，再迭代）。
- 覆盖核心规则：
  - 车/马/相/士/将/炮/兵
  - 河界限制、九宫限制、马腿、象眼、炮架、兵过河
  - 将帅照面禁手
- 增加最小单测集（每种棋子至少 2-3 条关键规则）。

## Phase 2：坐标与动画适配（1-2 天）
- 建立象棋坐标系统（如 `a0 ~ i9` 或自定义）。
- 打通 Scene 映射函数与历史记录显示。
- 调整吃子墓地、跳跃/平移动画参数。

## Phase 3：3D 资产接入（2-4 天）
- 接入象棋棋盘与棋子 GLB。
- 对每类棋子做缩放/位移/朝向调试。
- 固定参数，移除临时调试面板。

## Phase 4：UI 完整度（1-2 天）
- 走子记录兼容象棋记谱（先可用 from-to，后续升级标准记谱）。
- Undo/Restart 在象棋模式完整可用。
- 设置面板增加模式相关选项（可选）。

## Phase 5：回归与发布（1-2 天）
- 双模式回归测试（国际象棋不能退化）。
- 性能检查（对象数量、材质、阴影）。
- 文档补全（资产规范 + 规则说明 + 已知限制）。

## 5. 里程碑验收标准
- M1：象棋占位模式可走子、可吃子、可 Undo/Restart。
- M2：核心规则正确（含将帅照面、炮架、马腿）。
- M3：象棋 3D 资产完整替换，交互稳定。
- M4：双模式切换稳定，构建通过，文档齐全。

## 6. 风险与应对
- 规则复杂导致 Bug：先覆盖高风险规则并加单测。
- 资产坐标不统一：坚持“调试面板 -> 固定参数”流程。
- 双模式耦合过高：保持 `GameLogic` / `XiangqiLogic` 分离。

## 7. 下一步建议（可立即开始）
1. 先做 Phase 0：加 `mode` 开关与 `XiangqiLogic` 空壳接口。
2. 再做 Phase 1：优先实现车、炮、马（最影响可玩性）。
3. 最后接象棋棋盘与棋子模型，按现有方式逐个校准参数。
